<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>배송장소 표시</title>
    <style type="text/css">
      .mapIconDesc {
        position: absolute;
        bottom: 50px;
        left: 0;
        padding: 10px;
        background: rgba(255, 255, 255, 0.7);
        z-index: 999;
      }
      .mapIconBox {
        display: flex;
        align-items: center;
      }
      .mapIconBox img {
        width: 30px;
        height: 27px;
      }
      .mapIconBox p {
        font-size: 12px;
        margin-left: 6px;
      }

      .myGeo {
        z-index: 999;
        position: absolute;
        display: flex;
        justify-content: center;
        align-items: center;
        bottom: 50px;
        right: 15px;
        width: 35px;
        height: 35px;
        border-radius: 5px;
        background: rgb(245, 245, 245);
        /* background: red; */
        box-shadow: 0px 0px 2px 2px rgb(212, 212, 212);
      }
      .myGeo.refresh {
        bottom: 105px;
      }
      .myGeo a {
        display: flex;
        flex: 1;
        justify-content: center;
        align-items: center;
      }
      .myGeo a img {
        width: 70%;
      }
    </style>
  </head>
  <body style="margin: 0">
    <div id="map" style="width: 100vw; height: 100vh">
      <!-- <div class="mapIconDesc">
        <div class="mapIconBox">
          <img src="./img/marker_Incomplete.png" />
          <p>배송대기건</p>
        </div>
        <div class="mapIconBox">
          <img src="./img/marker_complete.png" />
          <p>처리완료건</p>
        </div>
        <div class="mapIconBox">
          <img src="./img/marker_select.png" />
          <p>선택한 배송건</p>
        </div>
      </div> -->
      <div class="myGeo refresh">
        <a onclick="refreshData()"><img src="./img/reload.svg" /></a>
      </div>
      <div class="myGeo">
        <a onclick="myGeolocation()"><img src="./img/locate.svg" /></a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.2.1.js"></script>
    <!-- <script
  type="text/javascript"
  src="//dapi.kakao.com/v2/maps/sdk.js?appkey=16684e5f789d589238bd0290a36f1c75&libraries=services,clusterer"
></script> -->
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=16684e5f789d589238bd0290a36f1c75&libraries=services,clusterer"
    ></script>
    <script>
      //기본 단위 설정
      var MARKER_WIDTH = 40,
        MARKER_HEIGHT = 37,
        SELECT_MARKER_WIDTH = 45,
        SELECT_MARKER_HEIGHT = 42,
        MARKER_DEFAULT_URL = "./img/marker_Incomplete.png",
        MARKER_COMPLETE_URL = "./img/marker_complete.png",
        MARKER_SELECT_URL = "./img/marker_select.png";
      // 마커설정
      var IMAGE_SIZE = new kakao.maps.Size(MARKER_WIDTH, MARKER_HEIGHT), // 이미지 사이즈
        SELECT_IMAGE_SIZE = new kakao.maps.Size(
          SELECT_MARKER_WIDTH,
          SELECT_MARKER_HEIGHT
        ), //선택한 이미지 사이즈
        MAKER_DEFAULT_IMG = new kakao.maps.MarkerImage(
          MARKER_DEFAULT_URL,
          IMAGE_SIZE
        ), //미완료 배송 이미지 생성
        MAKER_COMPLETE_IMG = new kakao.maps.MarkerImage(
          MARKER_COMPLETE_URL,
          IMAGE_SIZE
        ), // 완료 배송 이미지
        MARKER_SELECT_IMG = new kakao.maps.MarkerImage(
          MARKER_SELECT_URL,
          SELECT_IMAGE_SIZE
        ); //선택한 배송 이미지

      var selectedMarker = null;
      var saveComplete = null;

      var mapContainer = document.getElementById("map"), // 지도를 표시할 div
        mapOption = {
          center: new kakao.maps.LatLng(37.5418739, 127.0600774), // 지도의 중심좌표
          level: 4, // 지도의 확대 레벨
        };

      var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

      // 주소-좌표 변환 객체를 생성합니다
      var geocoder = new kakao.maps.services.Geocoder();

      var clusterer = new kakao.maps.MarkerClusterer({
        map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
        averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
        minLevel: 5, // 클러스터 할 최소 지도 레벨
        disableClickZoom: true, // 클러스터 마커를 클릭했을 때 지도가 확대되지 않도록 설정한다
        styles: [{ // calculator 각 사이 값 마다 적용될 스타일을 지정한다
                width : '30px', height : '30px',
                background: 'rgba(92, 218, 200, .8)',
                borderRadius: '15px',
                color: '#000',
                textAlign: 'center',
                fontWeight: 'bold',
                lineHeight: '31px',
                boxShadow: '0px 0px 5px 5px rgba(92, 218, 200, .3)'
            },
            {
                width : '40px', height : '40px',
                background: 'rgba(32, 170, 151, .8)',
                borderRadius: '20px',
                color: '#000',
                textAlign: 'center',
                fontWeight: 'bold',
                lineHeight: '41px',
                boxShadow: '0px 0px 2px 2px rgba(32, 170, 151, .3)'
            },
            {
                width : '50px', height : '50px',
                background: 'rgba(37, 89, 81, .8)',
                borderRadius: '25px',
                color: '#000',
                textAlign: 'center',
                fontWeight: 'bold',
                lineHeight: '51px',
                boxShadow: '0px 0px 2px 2px rgba(37, 89, 81, .3)'
            },
            {
                width : '60px', height : '60px',
                background: 'rgba(16, 142, 233, .8)',
                borderRadius: '30px',
                color: '#000',
                textAlign: 'center',
                fontWeight: 'bold',
                lineHeight: '61px',
                boxShadow: '0px 0px 2px 2px rgba(16, 142, 233, .8)'
            }
        ]
      });
      // 마커를 표시할 위치와 title 객체 배열입니다
      // const positions = [
      //   {
      //     id: 1,
      //     address: "서울 성동구 뚝섬로 325-19",
      //     complete: false,
      //     delivery_type: "01",
      //     name: "한영관",
      //     memo: "",
      //     latitude: "37.541277",
      //     longtitude: "127.047261",
      //     children: [
      //       {
      //         id: 1,
      //         address: "서울 성동구 뚝섬로 325-19",
      //         complete: false,
      //         delivery_type: "01",
      //         name: "한영관",
      //         memo: "",
      //         latitude: "37.541277",
      //         longtitude: "127.047261",
      //       },
      //       {
      //         id: 2,
      //         address: "서울 성동구 광나루로4가길 5 1층",
      //         complete: true,
      //         delivery_type: "03",
      //         name: "천우희",
      //         memo: "",
      //         latitude: "37.541294",
      //         longtitude: "127.047230",
      //       },
      //     ],
      //   },
      //   {
      //     id: 3,
      //     address: "서울 성동구 서울숲2길 16-8",
      //     complete: false,
      //     delivery_type: "01",
      //     name: "서현진",
      //     memo: "아기가 있어요 조용히 방문해주세요",
      //     latitude: "37.5469895",
      //     longtitude: "127.0380294",
      //     children: [
      //       {
      //         id: 3,
      //         address: "서울 성동구 서울숲2길 16-8",
      //         complete: false,
      //         delivery_type: "01",
      //         name: "서현진",
      //         memo: "아기가 있어요 조용히 방문해주세요",
      //         latitude: "37.5469895",
      //         longtitude: "127.0380294",
      //       },
      //     ],
      //   },
      //   {
      //     id: 4,
      //     address: "서울 성동구 서울숲2길 44-13 1층",
      //     complete: false,
      //     delivery_type: "02",
      //     name: "박보영",
      //     memo: "어쩌구 저쩌구",
      //     latitude: "37.5460426",
      //     longtitude: "127.041149",
      //     children: [
      //       {
      //         id: 4,
      //         address: "서울 성동구 서울숲2길 44-13 1층",
      //         complete: false,
      //         delivery_type: "02",
      //         name: "박보영",
      //         memo: "어쩌구 저쩌구",
      //         latitude: "37.5460426",
      //         longtitude: "127.041149",
      //       },
      //     ],
      //   },
      //   {
      //     id: 5,
      //     address: "서울 성동구 성수이로7가길 13 1층",
      //     complete: true,
      //     delivery_type: "03",
      //     name: "한소희",
      //     memo: "",
      //     latitude: "37.5414092",
      //     longtitude: "127.0528612",
      //     children: [
      //       {
      //         id: 5,
      //         address: "서울 성동구 성수이로7가길 13 1층",
      //         complete: true,
      //         delivery_type: "03",
      //         name: "한소희",
      //         memo: "",
      //         latitude: "37.5414092",
      //         longtitude: "127.0528612",
      //       },
      //     ],
      //   },
      //   {
      //     id: 6,
      //     address: "서울 성동구 서울숲2길 40 2층 비스트로성수",
      //     complete: false,
      //     delivery_type: "02",
      //     name: "배수지",
      //     memo: "현관 비밀번호 ****이에요",
      //     latitude: "37.5463357",
      //     longtitude: "127.0408389",
      //     children: [
      //       {
      //         id: 6,
      //         address: "서울 성동구 서울숲2길 40 2층 비스트로성수",
      //         complete: false,
      //         delivery_type: "02",
      //         name: "배수지",
      //         memo: "현관 비밀번호 ****이에요",
      //         latitude: "37.5463357",
      //         longtitude: "127.0408389",
      //       },
      //     ],
      //   },
      //   {
      //     id: 7,
      //     address: "서울 성동구 뚝섬로9길 20 2층",
      //     complete: false,
      //     delivery_type: "01",
      //     name: "고윤정",
      //     memo: "",
      //     latitude: "37.5398975",
      //     longtitude: "127.0540246",
      //     children: [
      //       {
      //         id: 7,
      //         address: "서울 성동구 뚝섬로9길 20 2층",
      //         complete: false,
      //         delivery_type: "01",
      //         name: "고윤정",
      //         memo: "",
      //         latitude: "37.5398975",
      //         longtitude: "127.0540246",
      //       },
      //     ],
      //   },
      //   {
      //     id: 8,
      //     address: "서울 성동구 서울숲4길 18-8 지층",
      //     complete: true,
      //     delivery_type: "03",
      //     name: "혜리",
      //     memo: "잘 놓고 가주세요~",
      //     latitude: "37.5470041",
      //     longtitude: "127.0404734",
      //     children: [
      //       {
      //         id: 8,
      //         address: "서울 성동구 서울숲4길 18-8 지층",
      //         complete: true,
      //         delivery_type: "03",
      //         name: "혜리",
      //         memo: "잘 놓고 가주세요~",
      //         latitude: "37.5470041",
      //         longtitude: "127.0404734",
      //       },
      //     ],
      //   },
      //   {
      //     id: 9,
      //     address: "서울 성동구 아차산로7길 7 동진빌딩 1층 성수족발",
      //     complete: false,
      //     delivery_type: "01",
      //     name: "전소민",
      //     memo: "요요요요",
      //     latitude: "37.5460109",
      //     longtitude: "127.052102",
      //     children: [
      //       {
      //         id: 9,
      //         address: "서울 성동구 아차산로7길 7 동진빌딩 1층 성수족발",
      //         complete: false,
      //         delivery_type: "01",
      //         name: "전소민",
      //         memo: "요요요요",
      //         latitude: "37.5460109",
      //         longtitude: "127.052102",
      //       },
      //     ],
      //   },
      //   {
      //     id: 10,
      //     address: "서울 성동구 서울숲4길 27",
      //     complete: true,
      //     delivery_type: "03",
      //     name: "아이유",
      //     memo: "",
      //     latitude: "37.5470143",
      //     longtitude: "127.0418555",
      //     children: [
      //       {
      //         id: 10,
      //         address: "서울 성동구 서울숲4길 27",
      //         complete: true,
      //         delivery_type: "03",
      //         name: "아이유",
      //         memo: "",
      //         latitude: "37.5470143",
      //         longtitude: "127.0418555",
      //       },
      //     ],
      //   },
      // ];

      // 지도를 재설정할 범위정보를 가지고 있을 LatLngBounds 객체를 생성합니다
      var bounds = new kakao.maps.LatLngBounds();

      document.addEventListener("message", function (data) {
        // myGeolocation(); 주석처리제거
        setMap(JSON.parse(data.data).todayList);
        alert(JSON.parse(data.data).position)
       this.removeEventListener('message')
      });

      window.addEventListener("message", function (data) {
        myGeolocation();
        setMap(JSON.parse(data.data).todayList);
       this.removeEventListener('message')
      });

      // setMap(positions);

      // 배송기사 현재 위치 알아내는 함수실행
      // myGeolocation();

      //마커생성 함수
      function setMap(positions) {
        for (var i = 0; i < positions.length; i++) {
          // 마커 이미지의 이미지 크기 입니다
          const delivery_id = positions[i]?.id; // 딜리버리 아이디 생성
          const delivery_complete = positions[i]?.complete;
        }
        // console.log(loc);
        // 데이터에서 좌표 값을 가지고 마커를 표시합니다
        // 마커 클러스터러로 관리할 마커 객체는 생성할 때 지도 객체를 설정하지 않습니다
        var markers = $(positions).map(function (i, position) {
          const delivery_id = positions[i]?.id; // 딜리버리 아이디 생성
          var coords = new kakao.maps.LatLng(
            position.latitude,
            position.longtitude
          );
          const marker = new kakao.maps.Marker({
            map: map,
            position: coords,
            image: MAKER_DEFAULT_IMG,
          });
          // 클릭이벤트 추가
          kakao.maps.event.addListener(marker, "click", function () {
            if(window.ReactNativeWebView)
            window.ReactNativeWebView.postMessage(delivery_id);
            else console.log("실행 " + delivery_id);
          });

          bounds.extend(coords);
          // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
          map.setBounds(bounds);

          return marker;
        });

        // 클러스터러에 마커들을 추가합니다
        clusterer.addMarkers(markers);
        // 클러스터 클릭
        kakao.maps.event.addListener(
          clusterer,
          "clusterclick",
          function (cluster) {
            // 현재 지도 레벨에서 1레벨 확대한 레벨
            var level = map.getLevel() - 1;

            // 지도를 클릭된 클러스터의 마커의 위치를 기준으로 확대합니다
            map.setLevel(level, { anchor: cluster.getCenter() });
          }
        );

        // $(positions).map(function (i, position) {
        //   var coords = new kakao.maps.LatLng(
        //     position.latitude,
        //     position.longtitude
        //   );
        //   // 결과값으로 받은 위치를 마커로 표시합니다
        //   var marker = new kakao.maps.Marker({
        //     map: map,
        //     position: coords,
        //     image: MAKER_DEFAULT_IMG,
        //   });

        //   bounds.extend(coords);

        //   kakao.maps.event.addListener(marker, "click", function () {
        //   console.log("실행");
        // });
        // });
      }
      // 내위치 알아내기
      function myGeolocation() {
        // HTML5의 geolocation으로 사용할 수 있는지 확인합니다
        if (navigator.geolocation) {
          // GeoLocation을 이용해서 접속 위치를 얻어옵니다
          navigator.geolocation.getCurrentPosition(function (position) {
            var lat = position.coords.latitude, // 위도
              lon = position.coords.longitude; // 경도

            var locPosition = new kakao.maps.LatLng(lat, lon), // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성합니다
              message = '<div style="padding:5px;">여기에 계신가요?!</div>'; // 인포윈도우에 표시될 내용입니다

            // 마커와 인포윈도우를 표시합니다
            displayMarker(locPosition, message);
          });
        } else {
          // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다
          var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),
            message = "geolocation을 사용할수 없어요..";

          displayMarker(locPosition, message);
        }
      }

      // 내위치 마커 생성
      function displayMarker(locPosition, message) {
        // 마커를 생성합니다
        var content =
          '<div style="width:12px; height:12px; border-radius:100%; background:#108ee9; border:2px solid white; box-shadow: 0px 0px 2px 2px rgba(16,142,233,0.4)"></div>';

        var customOverlay = new kakao.maps.CustomOverlay({
          position: locPosition,
          content: content,
        });

        // 커스텀 오버레이를 지도에 표시합니다
        customOverlay.setMap(map);
        // 지도 중심좌표를 접속위치로 변경합니다
        map.setCenter(locPosition);
      }

      // 리스트 새로고칭
      function refreshData() {
        window.ReactNativeWebView.postMessage(
          JSON.stringify({ refresh: true })
        );
      }
    </script>
  </body>
</html>
